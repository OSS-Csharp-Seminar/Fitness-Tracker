@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager NavigationManager

<PageTitle>PushApps - Fitness aplikacija</PageTitle>
<HeadContent>
    <link rel="stylesheet" href="/userlogin1.css" />
</HeadContent>

<div class="hero-page">
    <div class="nav-container">
        <nav class="navbar">
            <div class="navbar-brand">
                <a href="/">PushApps</a>
            </div>
            <div class="navbar-links">
                <a href="/workouts/daily-training@GetUrlParams()" class="nav-link @GetMainActiveClass("workouts")">WORKOUTS</a>
                <a href="/my-plan/dashboard@GetUrlParams()" class="nav-link @GetMainActiveClass("my-plan")">MY PLAN</a>
                <a href="/meals/today@GetUrlParams()" class="nav-link @GetMainActiveClass("meals")">MEALS</a>
                <a href="/profile/personal@GetUrlParams()" class="nav-link @GetMainActiveClass("profile")">MY PROFILE</a>
            </div>
        </nav>
    </div>

    <div class="content-wrapper">
        <div class="sidebar">
            <h4 class="sidebar-title">@GetSidebarTitle()</h4>
            <ul class="sidebar-menu">
                @if (CurrentSection == "workouts")
                {
                    <li class="sidebar-item">
                        <a href="/workouts/daily-training@GetUrlParams()" class="sidebar-link @GetActiveClass("workouts/daily-training")">
                            Day Training
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/workouts/training-history@GetUrlParams()" class="sidebar-link @GetActiveClass("workouts/training-history")">
                            Training History
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/workouts/view-all@GetUrlParams()" class="sidebar-link @GetActiveClass("workouts/view-all")">
                            View all Workouts
                        </a>
                    </li>
                }
                else if (CurrentSection == "my-plan")
                {
                    <li class="sidebar-item">
                        <a href="/my-plan/dashboard@GetUrlParams()" class="sidebar-link @GetActiveClass("/my-plan/dashboard")">
                            Dashboard
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/my-plan/create-plan@GetUrlParams()" class="sidebar-link @GetActiveClass("/my-plan/create-plan")">
                            Create New Plan
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/my-plan/my-plans@GetUrlParams()" class="sidebar-link @GetActiveClass("/my-plan/my-plans")">
                            My Plans
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/my-plan/progress@GetUrlParams()" class="sidebar-link @GetActiveClass("/my-plan/progress")">
                            Progress Tracking
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/my-plan/statistics@GetUrlParams()" class="sidebar-link @GetActiveClass("/my-plan/statistics")">
                            Statistics
                        </a>
                    </li>
                }
                else if (CurrentSection == "meals")
                {
                    <li class="sidebar-item">
                        <a href="/meals/today@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/today")">
                            Today's Meals
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/meals/add@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/add")">
                            Add Meal
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/meals/history@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/history")">
                            Meal History
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/meals/recipes@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/recipes")">
                            Recipes
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/meals/nutrition@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/nutrition")">
                            Nutrition Tracker
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/meals/shopping@GetUrlParams()" class="sidebar-link @GetActiveClass("/meals/shopping")">
                            Shopping List
                        </a>
                    </li>
                }
                else if (CurrentSection == "profile")
                {
                    <li class="sidebar-item">
                        <a href="/profile/personal@GetUrlParams()" class="sidebar-link @GetActiveClass("/profile/personal")">
                            Personal Info
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/profile/physical@GetUrlParams()" class="sidebar-link @GetActiveClass("/profile/physical")">
                            Physical Data
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/profile/preferences@GetUrlParams()" class="sidebar-link @GetActiveClass("/profile/preferences")">
                            Preferences
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/profile/account@GetUrlParams()" class="sidebar-link @GetActiveClass("/profile/account")">
                            Account Settings
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/profile/notifications@GetUrlParams()" class="sidebar-link @GetActiveClass("/profile/notifications")">
                            Notifications
                        </a>
                    </li>
                }
            </ul>
        </div>

        <div class="main-content">
            @Body
        </div>
    </div>
</div>

<footer class="nav-container">
</footer>

@code {
    private string userId = "";
    private string userName = "";

    protected override void OnParametersSet()
    {
        // Poziva se svaki put kada se promijene parametri ili URL
        UpdateUrlParameters();
    }

    private void UpdateUrlParameters()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            userId = query.TryGetValue("userId", out var userIdValue) ? userIdValue.ToString() : "";
            userName = query.TryGetValue("userName", out var userNameValue) ? userNameValue.ToString() : "";
        }
        catch
        {
            // Fallback ako nešto pođe po zlu
            userId = "";
            userName = "";
        }
    }

    private string CurrentSection
    {
        get
        {
            var currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

            if (currentPath.StartsWith("workouts"))
                return "workouts";
            else if (currentPath.StartsWith("my-plan") || currentPath.StartsWith("dashboard"))
                return "my-plan";
            else if (currentPath.StartsWith("meals"))
                return "meals";
            else if (currentPath.StartsWith("profile"))
                return "profile";

            return "workouts"; // default
        }
    }

    private string GetSidebarTitle()
    {
        return CurrentSection switch
        {
            "workouts" => "Workouts",
            "my-plan" => "My Plan",
            "meals" => "Meals",
            "profile" => "Profile",
            _ => "Navigation"
        };
    }

    private string GetActiveClass(string path)
    {
        var currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        return currentPath.StartsWith(path.TrimStart('/')) ? "active" : "";
    }

    private string GetMainActiveClass(string section)
    {
        return CurrentSection == section ? "active" : "";
    }

    /// <summary>
    /// KLJUČNA METODA - dodaje userId i userName na sve linkove
    /// </summary>
    private string GetUrlParams()
    {
        if (!string.IsNullOrEmpty(userId) && !string.IsNullOrEmpty(userName))
        {
            return $"?userId={userId}&userName={userName}";
        }
        return "";
    }

    [Parameter]
    public RenderFragment LeftContent { get; set; }

    [Parameter]
    public RenderFragment RightContent { get; set; }
}